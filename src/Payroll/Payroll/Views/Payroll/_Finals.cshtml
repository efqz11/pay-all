@model PayrollVm
@using Microsoft.AspNetCore.Http
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    var firstRow = Model.PayrollPeriod.PayrollPeriodEmployees.FirstOrDefault() == null ? null : Model.PayrollPeriod.PayrollPeriodEmployees.FirstOrDefault();
    if (firstRow != null)
    {
        firstRow.VariationKeyValues = firstRow.VariationKeyValues.OrderBy(x => x.MultiOrder).ToList();
    }
}


<div class="row mt-4">
    <div class="col pr-0">
        <h5 class="text-left">
            Final Master Sheet
            @*<br />
                <small class="pt-1">View and Export</small>*@
        </h5>
    </div>
    <div class="col">
        <div class="btn-toolbar float-right mr-2 mb-3">
            <div class="btn-group btn-group-afjustment" role="group" aria-label="Third group">

                <a class="btn-add btn btn-sm btn-primary" asp-route-id="@Model.PayrolPeriodId" asp-action="Recalculate" data-ajax-method="POST" data-ajax-begin="convertToLoadingTable('.table-master-data');openLoadingModal('Generating Payroll', 'Please wait until payroll is completed and master sheet is generated. This may take some time')" data-ajax-success="shideModal('Payroll @Model.PayrollPeriod.Name was genenerated successfully');$('#_LoadMasterSheet').click()" data-ajax-confirm="Are you sure you wish to re-calculate and generate master data sheet. This will obselete all existing calculated records" data-ajax-failure="hideFailedLoadingModalCustom('There was an error while creating table');handleModalPostFailure" data-ajax="true"><i class="ion-android-refresh"></i> Re-Run Payroll</a>

                <a class="btn-save btn btn-sm btn-primary" asp-route-id="@Model.PayrolPeriodId" asp-action="ExportPayroll" data-ajax-begin="showModal()" data-ajax-update=".modal__container" data-ajax-failure="handleModalPostFailure" data-ajax="true"><i class="ion-android-mail"></i> Export</a>

                <a class="btn-clear btn btn-sm btn-danger" asp-route-id="@Model.PayrolPeriodId" asp-action="ClearAll" data-ajax-method="POST" data-ajax-loading=".loading" data-ajax-success="$('#_LoadMasterSheet').click();" data-ajax-confirm="Are you sure you wish to clear all records. This action is irreversible and all data entered to this payrol will be removed" data-ajax-begin="convertToLoadingTable('.table-master-data')" data-ajax="true"><i class="fa fa-minus-circle "></i> Clear</a>
            </div>
        </div>

        @*<div class="btn-toolbar float-right" role="toolbar" aria-label="Toolbar with button groups">
                <div class="float-right mr-2">
                    <select class="form-control form-control-sm empId" style="width:250px !important" name="empId" id="empId" onchange="makeAjaxRequest_UpdateMasterSheet()"></select>
                </div>
            </div>*@
    </div>
</div>
@*<button class="btn btn-info">
        <div class="loader loader-white btn-loading" data-page="2" style="line-height: 1px;display:block">
            <div class="ball-beat"><div></div><div></div><div></div></div>
        </div>
    </button>*@
<div id="finals-table" class="mt-2">
    @if (Model?.PayrollPeriod.PayrollPeriodEmployees == null || Model.PayrollPeriod.PayrollPeriodEmployees.Count() <= 0)
    {
        <div class="row justify-content-center text-center">
            <div class="col-12 col-md-10 mt-5">

                <i class="fad fa-braille fa-5x mb-2"></i>
                <h2>
                    Empty Master Sheet
                </h2>

                <p class="text-muted">
                    There is no master data. Kindly add values to adjustment components using <strong>calculations</strong> tab above.
                </p>

                <button class="btn btn-lg btn-danger d-none d-md-inline-block mt-3" onclick="$('.btn-add').click()">RUN PAYROLL</button>
                <br />

                @*<button class="btn btn-lg btn-primary" onclick="$('.tab-link[data-tab=\'2\']').click();">Manage Adjustment</button>*@

                <p class="text-muted mt-1">
                    <small>Recalculation will remove all old values previously created and new values will be populated</small>
                </p>
            </div>
        </div> <!-- / .row -->
    }
    else
    {
        @*@Html.Raw(Model.PayrollPeriod.Status)*@
        <table class="table table-sm table-hover table-responsive table-master-data" id="table-master-data">
            <thead>
                <tr>
                    <th style="width:130px;table-layout: fixed" class="text-left">Employee</th>
                    @foreach (var item in firstRow.VariationKeyValues.Where(v => v.Type == VariationType.ConstantAddition || v.Type == VariationType.VariableAddition))
                    {
                        <th class="td-adj">@item.Key</th>
                    }
                    <th><span class="font-weight-bold">Gross Pay</span></th>
                    @foreach (var item in firstRow.VariationKeyValues.Where(v => v.Type == VariationType.ConstantDeduction || v.Type == VariationType.VariableDeduction))
                    {
                        <th class="td-adj">@item.Key</th>
                    }
                    <th><span class="font-weight-bold">Net Salary</span></th>
                </tr>
            </thead>
            <tbody>
                <partial name="_PayrolMasterSheet" model="@Model.PayrollPeriod.PayrollPeriodEmployees" />
                @*@if (Model.PayrollPeriodEmployees.Any())
                    {

                        @foreach (var item in Model.PayrollPeriodEmployees)
                        //.OrderBy(x=> x.Employee.Department.Name).ThenBy(x=>  x.Employee.Name))
                        {
                            <tr>
                                <td width="30%">
                                    <a asp-action="Detail" asp-controller="Employee" asp-route-id="@item.EmployeeId">@item.EmpID | @item.Name</a>
                                </td>
                                <td>
                                    @(item.Employee?.Department?.Name ?? "NA")
                               </td>
                               @foreach (var add in firstRow.VariationKeyValues.Where(v => v.Type == VariationType.ConstantAddition || v.Type == VariationType.VariableAddition))
                                {
                                    <td>
                                        @item.VariationKeyValues.Where(x => (x.Type == VariationType.ConstantAddition || x.Type == VariationType.VariableAddition) && x.KeyId == add.KeyId)?.Sum(x => x.Value).ToString("N2")
                                    </td>
                                }
                                <td><b>@item.GrossPay.ToString("N2")</b></td>
                                @foreach (var ddd in firstRow.VariationKeyValues.Where(v => v.Type == VariationType.ConstantDeduction || v.Type == VariationType.VariableDeduction))
                                {
                                    <td>
                                        @(item.VariationKeyValues.Where(x => (x.Type == VariationType.ConstantDeduction || x.Type == VariationType.VariableDeduction) && x.KeyId == ddd.KeyId)?.Sum(x => x.Value).ToString("N2"))
                                    </td>
                                }
                                <td><b>@item.NetSalary.ToString("N2")</b></td>
                            </tr>
                        }
                    }*@
            </tbody>
            <tfoot>
                <tr>
                    <td width="30%" class="text-left" style="font-size: 11pt;font-weight: 500">
                        Total for all Employees
                    </td>
                    <td></td>

                    @foreach (var add in firstRow.VariationKeyValues.Where(v => v.Type == VariationType.ConstantAddition || v.Type == VariationType.VariableAddition))
                    {
                        <td class="td-adj"></td>
                    }
                    <td></td>
                    @foreach (var ddd in firstRow.VariationKeyValues.Where(v => v.Type == VariationType.ConstantDeduction || v.Type == VariationType.VariableDeduction))
                    {
                        <td class="td-adj"></td>
                    }
                    <td></td>
                </tr>
            </tfoot>
        </table>


        <div class="text-center">
            <button type="button" class="btn btn-outline-info btn-load-more btn-load-more-ms" data-page="1" style="display:none" onclick="$(this).data('page', (parseInt($(this).data('page') || 1) + 1)); makeAjaxRequest_UpdateMasterSheet();">Load More</button>
        </div>

        <div class="text-right">
            <h4 class="mb-1">MVR @Model.PayrollPeriod.PayrollPeriodEmployees.Sum(x => x.NetSalary).ToSystemFormat(User)</h4>
            <small> Total Payroll</small>
            <br />
            <small>@Html.Raw(HttpContextAccessor.HttpContext.Session.GetString(SessionVariables.EmployeeSelectorSummary) ?? "(no filter)")</small>
        </div>
    }

</div>


@*<div class="modal micromodal-slide" id="modal-regenerate-payroll" aria-hidden="true">
        <div class="modal__overlay" tabindex="-1" data-micromodal-close>
            <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-recreate-table-title" style="width: 100%;">
                <header class="modal__header text-center">
                    <h2 class="modal__title" id="modal-1-title">
                        Generating Payrol
                    </h2>
                    <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
                </header>
                <main class="modal__content" id="modal-1-content">
                    <div class="text-center d1">
                        <div class="loader loader-blue btn-loading mb-4" data-page="2" style="line-height: 1px;display:block">
                            <div class="ball-beat"><div></div><div></div><div></div></div>
                        </div>

                        <span class="d1-span">Please wait until payrol is completed and master sheet is generated. This may take some time</span>
                    </div>
                    <div class="text-center d2" style="display:none">
                        <span class="btn btn-success btn-lg mb-3"><b><i class="fa fa-check-circle"></i> Payrol Completed!</b></span>
                        <br />
                        <span class="d2-span"><b>Payrol</b> was successfully created for this period</span>
                        <br />
                        <small>@Model.PayrollPeriod.StartDate.GetDuration(Model.PayrollPeriod.EndDate)</small>
                    </div>
                </main>
                <footer class="modal__footer text-center">
                    <small>This window will close automatically</small>
                </footer>
            </div>
        </div>
    </div>*@




<script>

    loadEmpddSearch('.empId');

    $(function () {
        $('.table-master-data thead th').each(function (i) {
            if (i != 0)
                calculateColumn(i);
        });
    });
</script>